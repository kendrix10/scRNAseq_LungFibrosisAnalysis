---
title: "GSE135893 IPF Lung PreProcessing"
author: "Kendrix Kek"
date: "2025-11-18"
output:
  html_document:
    theme: sandstone
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "Z:/Kendrix")
```

```{r libraries, message=FALSE, warning=FALSE}
library(here)
library(DT)
library(GEOquery)
library(crayon)
library(RColorBrewer)
library(tidyverse)
library(Seurat)
library(SeuratData)
library(Azimuth)
library(patchwork)
library(Matrix)
library(RCurl)
library(scales)
library(clustree)
library(SoupX)
library(cowplot)
library(metap)
library(SingleCellExperiment)
library(DropletUtils)
library(AnnotationHub)
library(HGNChelper)
library(ensembldb)
library(multtest)
library(glmGamPoi)
library(pbapply)
library(scCustomize)
library(data.table)
library(ggrepel)
library(ggpubr)
library(stringr)
library(canvasXpress)
library(clinfun)
library(GGally)
library(factoextra)
library(DESeq2)
library(limma)
library(fgsea)
library(org.Mm.eg.db)
library(kableExtra)
```


## Step 1: Data Exploration and Object Creation

This dataset comes with both count matrix and a preprocessed RDS file. We could use the count matrix and apply it to the same preprocessing pipeline - however, the dimensions of the count matrix did not match the barcode and gene ID dimensions, so we will use the preprocessed Seurat and do some preliminary checks to ensure that the Seurat object meets out preprocessing criteria. 

### Step 1.1: Import pre-processed Seurat object

```{r import pre-processed Seurat object}
# Load Seurat object.
obj <- readRDS(file = "Z:/Kendrix/IPF_Lung/GSE135893/raw_data/GSE135893_ILD_annotated_fullsize.rds")
obj <- UpdateSeuratObject(obj)
```


### Step 1.2: Preliminary QC

Let's do some quick visualizations. 

```{r preliminary QC visualizations, out.width="100%"}
# Calculate novelty score.
obj$log10GenesPerUMI <- log10(obj$nFeature_RNA) / log10(obj$nCount_RNA)

# Get sample level metadata.
metadata <- Extract_Sample_Meta(obj, 
                                sample_col = "Sample_Name", 
                                variables_include = c("Diagnosis"))

# Plot sample data based on diagnosis.
ggplot(metadata, aes_string(x = "Diagnosis")) +
    geom_bar(fill = "darkslategrey", colour = "black") +
    geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5) +
    labs(title = paste("Distribution of Diagnosis in GSE135893"),
         x = "Diagnosis",
         y = "Count") +
    theme_bw()

# We are only interested in IPF and control, so subset the Seurat object based on those two only.
dim(obj) # 26,377; 114,396
subset_obj <- subset(obj, subset = Diagnosis %in% c("IPF", "Control"), invert = FALSE)
dim(subset_obj) # 26,377; 89,326
```

```{r}
# Remove unneeded objects.
rm(metadata, obj)
```


## Step 2: Quality Control

### Step 2.1: Visualize cell counts

Check cell counts with number of unique barcodes detected to determine capture efficiency.

```{r cell counts check, out.width="100%"}
# Get sample metadata from Seurat object.
meta <- subset_obj@meta.data

# Visualize cell counts.
meta %>%
  ggplot(aes(x = celltype, fill = Diagnosis)) +
  geom_bar(width = 0.5, position = "dodge") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  ggtitle("NCells")
```


### Step 2.2: Visualize UMI distribution across conditions

UMI counts should generally be above 500. If UMI counts are between 500 and 1000, the cells should probably be sequenced more deeply.

Note: Most are above 1000 so good sequencing depth.

```{r UMI density distribution, out.width="100%"}
# Visualize UMI counts per cell.
meta %>% 
  ggplot(aes(x = nCount_RNA, color = Diagnosis, fill = Diagnosis)) +
  geom_density(alpha = 0.2) +
  scale_x_log10(labels = label_number()) +
  ylab("Cell density") +
  geom_vline(xintercept = 500, linetype = "dashed", color = "red") +
  theme_classic()
```


### Step 2.3: Visualize cell novelty score

Cells with novelty score above 0.80 are considered good quality cells. 

Note: All cells are above 0.80 novelty score. 

```{r novelty score distribution, out.width="100%"}
# Visualize novelty score.
meta %>% 
  ggplot(aes(x = log10GenesPerUMI, color = Diagnosis, fill = Diagnosis)) +
  geom_density(alpha = 0.2) +
  geom_vline(xintercept = 0.8, linetype = "dashed", color = "red") +
  theme_classic()
```


### Step 2.4: Visualize mito ratio

Low quality cells have mitochondrial ratio higher than 0.20.

Note: All cells below mito ratio of 0.20.

```{r mito ratio distribution, out.width="100%"}
# Visualize mitochondrial ratio.
meta %>%
  ggplot(aes(x = percent.mt, color = Diagnosis, fill = Diagnosis)) +
  geom_density(alpha = 0.2) +
  geom_vline(xintercept = 0.2, linetype = "dashed", color = "red") +
  theme_classic()
```


### Step 2.5: Visualize joint filtering effects

Note: Two cells in IPF drop below 250 nGene.

```{r joint filtering distribution, out.width="100%"}
# Visualize joint filtering QCs.
meta %>% 
    ggplot(aes(x = nCount_RNA, y = nFeature_RNA, color = percent.mt)) + 
    geom_point() + 
    scale_colour_gradient(low = "gray90", high = "black") +
    stat_smooth(method = lm) +
    scale_x_log10() + 
    scale_y_log10() + 
    geom_vline(xintercept = 500) +
    geom_hline(yintercept = 250) +
    theme_classic() +
    facet_wrap(~Diagnosis)
```


### Step 2.6: Visualize valid cells with knee plot

A distinct "cliff-and-knee" shape indicates a healthy sample with clear separation between true cells and background "empty" droplets, while other shapes can point to issues with sample quality. 

```{r knee plot distribution, out.width="100%"}
# Rank expression barcodes. 
br.out = barcodeRanks(subset_obj@assays$RNA$counts)

# Plot knee plot.
plot(br.out$rank, br.out$total, log = "xy", xlab = "Rank", ylab = "Total")
abline(h = metadata(br.out)$knee, col = "dodgerblue", lty = 2)
abline(h = metadata(br.out)$inflection, col = "forestgreen", lty = 2)
legend("bottomleft", lty = 2, col = c("dodgerblue", "forestgreen"), legend = c("knee", "inflection"))
```

```{r}
# Remove unneeded objects.
rm(br.out, meta)
```

All the QC checks look good. We are not going to do any cell-level or gene-level filtering since we have less than ideal number of cells available to us. 


## Step 3: Normalization

### Step 3.1: Pre-normalization distribution

```{r pre-normalization distribution, out.width="100%"}
# Visualize expression distribution before normalization.
hist(colSums(subset_obj[["RNA"]]$counts), 
     breaks = 100, 
     col = "#212226",
     main = "Pre-Normalization: Expression distribution", 
     xlab = "Sum of expression")
```


### Step 3.2: Post-normalization distribution

```{r SCTransformed normalization visualization, out.width="100%"}
# Visualize expression distribution after SCT.
hist(colSums(subset_obj[["SCT"]]$data), 
     breaks = 100, 
     col = "#b14b34",
     main = "Post-SCTransformed: Log-normalized expression distribution", 
     xlab = "Sum of expression")
```


## Step 4: Dimensional Reduction and Clustering

### Step 4.1: Run PCA 

Note: PC15 describes approximately 50% cumulative variation in the data. The elbow plot bends at approximately PC30, which describes approximately 75% cumulative variation. For now, we will run UMAP with these 30 PCS included since this is also the Seurat default. 

```{r run PCA and visualize dimension reduction, out.width="100%"}
# Run PCA.
seurat_sct <- RunPCA(subset_obj, verbose = FALSE)

# Visualize PC dimensions with elbow plot.
# Determine percent of variation associated with each PC.
pct <- seurat_sct[["pca"]]@stdev / sum(seurat_sct[["pca"]]@stdev) * 100

# Calculate cumulative percents for each PC.
cumu <- cumsum(pct)

# Determine which PC exhibits cumulative percent greater than 90% and % variation associated with the PC as less than 5.
co1 <- which(cumu > 90 & pct < 5)[1]
co1

# Determine the difference between variation of PC and subsequent PC.
co2 <- sort(which((pct[1:length(pct) - 1] - pct[2:length(pct)]) > 0.1), decreasing = T)[1] + 1

# Last point where change of % of variation is more than 0.1%.
co2

# Minimum of the two calculation.
pcs <- min(co1, co2)
pcs

# Create a dataframe with values.
elbowplot_df <- data.frame(pct = pct, 
                           cumu = cumu, 
                           rank = 1:length(pct))

# Elbow plot to visualize.
ggplot(elbowplot_df, aes(cumu, pct, label = rank, color = rank > pcs)) + 
  geom_text() + 
  geom_vline(xintercept = 90, color = "grey") + 
  geom_hline(yintercept = min(pct[pct > 5]), color = "grey") +
  theme_bw()

# Remove unneeded objects.
rm(co1, co2, cumu, elbowplot_df, pcs, pct)
```


### Step 4.2: Run UMAP

```{r run UMAP, out.width="100%"}
# Visualize dimension reduction from PCA.
seurat_sct <- RunUMAP(seurat_sct, dims = 1:30, reduction = "pca")
DimPlot(object = seurat_sct, group.by = "Diagnosis")

# Explore the top PC markers.
DimHeatmap(seurat_sct, 
           dims = 1:15, 
           cells = 500, 
           balanced = TRUE)
```


### Step 4.3: Compute KNN

```{r find neighbours}
# Compute SNN graph.
seurat_cluster <- FindNeighbors(object = seurat_sct, dims = 1:30) # Based on elbow plot.
```

```{r}
# Remove unneeded objects.
rm(seurat_sct)
```


### Step 4.4: Explore cluster resolutions

Note: Resolution at around 0.8 looks stable. 

```{r explore cluster resolutions, out.width="100%"}
# Determine start and end resolution range.
start_reso_range = 0.6
end_reso_range = 1.2
range_interval = 0.2

# Find clusters given the range.
seurat_cluster <- FindClusters(object = seurat_cluster,
                               resolution = seq(from = start_reso_range,
                                                to = end_reso_range,
                                                by = range_interval))

# Remove unneeded objects.
rm(start_reso_range, end_reso_range, range_interval)

# Visualize relationship between different cluster resolutions using clustree.
clustree(seurat_cluster)
```


### Step 4.5: Choose cluster resolution

Note: Resolution at around 0.8 looks stable based on clustree above. 

```{r choose cluster resolution, out.width="100%"}
# Assign desired cluster resolution as identity of Seurat.
Idents(object = seurat_cluster) <- "SCT_snn_res.0.8"

# Visualize cluster with a UMAP.
DimPlot(seurat_cluster,
        reduction = "umap",
        label = TRUE,
        label.size = 3) + 
  ggtitle("SCT_snn_res.0.8") +
  NoLegend()
```


## Step 5: Cell Type Annotation

### Step 5.1: Find top markers associated with each cluster

```{r find markers}
# Find markers for every cluster compared to all remaining cells. Include only positive markers. 
cluster_markers <- FindAllMarkers(seurat_cluster, only.pos = TRUE)
datatable(
  cluster_markers %>% 
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_max(order_by = p_val_adj, n = 10, with_ties = FALSE) %>%
    arrange(cluster, p_val_adj),
  caption = "Top 10 highly differential markers by cluster",
  options = list(pageLength = 10, scrollX = TRUE),
  rownames = FALSE
) %>%
  formatRound(columns = c("avg_log2FC"), digits = 3) %>%
  formatSignif(columns = c("p_val"), digits = 3) %>%
  formatSignif(columns = c("p_val_adj"), digits = 3)
```

```{r}
# Remove unneeded objects.
rm(cluster_markers)
```


### Step 5.2: Visualize clusters against known markers

```{r dotplot cluster marker visualization, out.width="100%"}
# Visualize the clusters against [known markers of interest](https://pmc.ncbi.nlm.nih.gov/articles/PMC9202574/).
# Basal cells: TP63, KRT5
# Secretory cells: SCGB1A1, SCGB3A2
# Ciliated cells: FOXJ1, RSPH1
# Goblet cells: MUC5AC, SPDEF
# Tuft cells: POU2F3, ASCL2
# Ionocytes: FOXI1, ASCL3
# AT1: AGERH, RTKN2
# AT2: SFTPC, LAMP3
# Mucous cells: MUC5B, SPDEF
# Airway SMCs: ACTA2, DES, LGR6
# vSMCs: NTRK3, ITGA7
# Alveolar fibroblasts 1: TCF21, WNT2
# Alveolar fibroblasts 2: MFAP5, SCARA5
# Pericytes: TRPC6, LAMC3
# Mesothelium: WT1, UPK3B, FREM2
# Arterial endothelial cells: DKK2, GJA5
# Venous endothelial cells: ACKR1, HDAC9
# Lymphatic endothelial cells: PROX1, MMRN1
DotPlot(seurat_cluster,
        features = c("TP63", "KRT5", 
                     "SCGB1A1", "SCGB3A2",
                     "FOXJ1", "RSPH1",
                     "MUC5AC", "SPDEF",
                     "POU2F3", "ASCL2",
                     "FOXI1", "ASCL3",
                     "RTKN2",
                     "SFTPC", "LAMP3",
                     "MUC5B", 
                     "ACTA2", "DES", "LGR6",
                     "NTRK3", "ITGA7",
                     "TCF21", "WNT2",
                     "MFAP5", "SCARA5",
                     "TRPC6", "LAMC3",
                     "WT1", "UPK3B", "FREM2",
                     "DKK2", "GJA5",
                     "ACKR1", "HDAC9",
                     "PROX1", "MMRN1"),
        cluster.idents = TRUE,
        cols = c("#d6cfc7", "#01013f"),
        dot.scale = 6,
        scale.by = "size") +
  ggtitle("Cluster identitities by known markers") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


### Step 5.3: Run Azimuth annotation

Note: Prediction score is high across the board for all cell types. 

```{r run Azimuth}
# Check all available Azimuth references.
available_data <- AvailableData()
available_data[grep("lung", available_data[, 3]), 1:3] # Use lungref.

# Run Azimuth with lungref.
options(future.globals.maxSize = 1000000000)
seurat_annotated <- RunAzimuth(seurat_cluster, reference = "lungref")

# Check annotation accuracy.
Idents(seurat_annotated) <- "predicted.ann_finest_level"
FeaturePlot(
  seurat_annotated,
  features = "mapping.score",
  cols = c("#01013f", "#59974d", "#fff000"),
  label = TRUE,
  label.size = 3,
  repel = TRUE,
  label.color = "black"
) + 
  theme(axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  ggtitle("Azimuth prediction accuracy score")
```

```{r}
# Remove unneeded object.
rm(available_data, seurat_cluster)
```


### Step 5.4: Collapse similar cell type groups

```{r collapse cell type groups}
# Find unique identified cell types.
seurat_annotated$cell_type = seurat_annotated$predicted.ann_finest_level
unique(seurat_annotated$cell_type) %>% sort()

# Collapse all the endothelial cells.
grep("EC", seurat_annotated$cell_type, value = TRUE) %>% unique()
seurat_annotated@meta.data <- mutate(seurat_annotated@meta.data,
                                     cell_type =
                                       recode(cell_type,
                                              "EC arterial" = "Endothelial",
                                              "EC venous pulmonary" = "Endothelial",
                                              "EC general capillary" = "Endothelial",
                                              "EC venous systemic" = "Endothelial",
                                              "EC aerocyte capillary" = "Endothelial",
                                              "Lymphatic EC mature" = "Lymphatic EC",
                                              "Lymphatic EC differentiating" = "Lymphatic EC",
                                              "Lymphatic EC proliferating" = "Lymphatic EC"))

# Collapse all the fibroblasts.
grep("fibroblast", seurat_annotated$cell_type, value = TRUE) %>% unique()
seurat_annotated@meta.data <- mutate(seurat_annotated@meta.data,
                                     cell_type = 
                                       recode(cell_type,
                                              "Adventitial fibroblasts" = "Fibroblasts",
                                              "Alveolar fibroblasts" = "Fibroblasts",
                                              "Peribronchial fibroblasts" = "Fibroblasts",
                                              "Subpleural fibroblasts" = "Fibroblasts"))

# Collapse all the immune cells.
seurat_annotated$cell_type[seurat_annotated$predicted.ann_level_1 == "Immune"] %>% unique()
seurat_annotated@meta.data <- mutate(seurat_annotated@meta.data,
                                     cell_type = 
                                       recode(cell_type,
                                              "CD8 T cells" = "Immune",
                                              "Non-classical monocytes" = "Immune",
                                              "Monocyte-derived Mφ" = "Immune",
                                              "B cells" = "Immune",
                                              "Alveolar macrophages" = "Immune",
                                              "Plasma cells" = "Immune",
                                              "Mast cells" = "Immune",
                                              "Plasmacytoid DCs" = "Immune",
                                              "CD4 T cells" = "Immune",
                                              "Alveolar Mφ proliferating" = "Immune",
                                              "DC2" = "Immune",
                                              "Interstitial Mφ perivascular" = "Immune",
                                              "Classical monocytes" = "Immune",
                                              "T cells proliferating" = "Immune",
                                              "Alveolar Mφ CCL3+" = "Immune",
                                              "NK cells" = "Immune",
                                              "Migratory DCse" = "Immune",
                                              "DC1" = "Immune",
                                              "Alveolar Mφ MT-positive" = "Immune"))
```


### Step 5.5: Visualize finalized cell type annotation

```{r cell type annotation visualization, message=FALSE, warning=FALSE, out.width="100%"}
 # Visualize finalized annotation with a UMAP.
DimPlot(seurat_annotated,
        reduction = "umap",
        group.by = "cell_type",
        label = TRUE,
        label.size = 4,
        repel = TRUE) + 
  ggtitle("Final cell type annotation") +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.spacing.x = unit(0.2, "cm"),
        legend.spacing.y = unit(0.1, "cm")) +
  guides(colour = guide_legend(nrow = 4))
```


## Step 6: Save Seurat Object 

```{r save Seurat object}
# Save Seurat object.
saveRDS(object = seurat_annotated, 
        file = "Z:/Kendrix/IPF_Lung/GSE135893/processed_data/preprocessed_seurat_obj.rds")
```


